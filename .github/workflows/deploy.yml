name: Deploy

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prune non-runtime files
        run: |
          set -euxo pipefail
          rm -rf .git .github
          rm -rf scripts script tests test db node_modules
          rm -f README.md README.MD README_KR.md README_KO.md AGENTS.md agents.md SPEC.md TODO.md DOCKER.md docker-compose.yml Dockerfile Makefile test.txt

      - name: Inject build version into asset references
        run: |
          set -euxo pipefail
          VER="${GITHUB_SHA::7}-$(date -u +%Y%m%d%H%M%S)"
          sed -i "s/__BUILD__/${VER}/g" index.php || true

      - name: Resolve deployment target
        id: cfg
        run: |
          set -euxo pipefail
          SERVER="${{ secrets.FTP_SERVER }}"
          USERNAME="${{ secrets.FTP_USERNAME }}"
          PASSWORD="${{ secrets.FTP_PASSWORD }}"
          if [ -z "$SERVER" ] || [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
            echo "::error::Configure FTP_SERVER/FTP_USERNAME/FTP_PASSWORD secrets before deploying." >&2
            exit 1
          fi
          ROOT="/www"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          SLUG="$(printf '%s' "$REPO_NAME" | tr '[:upper:]' '[:lower:]')"
          case "$SLUG" in
            pick-a-ju) SLUG="pickaju" ;;
          esac
          DIR="${ROOT}/fun/${SLUG}/"
          case "$DIR" in
            */) : ;;
            *) DIR="${DIR%/}/" ;;
          esac
          {
            echo "server=$SERVER"
            echo "username=$USERNAME"
            echo "password=$PASSWORD"
            echo "dir=$DIR"
            echo "proto=ftp"
            echo "port=21"
          } >> "$GITHUB_OUTPUT"

      - name: Debug FTP working dir
        run: |
          python - <<'PY'
          import ftplib
          import os

          server = os.environ.get("FTP_SERVER")
          user = os.environ.get("FTP_USERNAME")
          pw = os.environ.get("FTP_PASSWORD")
          if not (server and user and pw):
              raise SystemExit("Missing FTP_SERVER/FTP_USERNAME/FTP_PASSWORD")

          ftp = ftplib.FTP()
          ftp.connect(server, 21, timeout=30)
          ftp.login(user, pw)

          def safe_pwd():
              try:
                  return ftp.pwd()
              except Exception as e:
                  return f"PWD failed: {e}"

          def safe_nlst(path):
              try:
                  return ftp.nlst(path)
              except Exception as e:
                  return [f"NLST failed for {path}: {e}"]

          def safe_cwd(path):
              try:
                  ftp.cwd(path)
                  return f"OK: {path} -> {ftp.pwd()}"
              except Exception as e:
                  return f"FAIL: {path} -> {e}"

          print("PWD:", safe_pwd())
          for path in [".", "/", "/ciiwol", "/ciiwol/www", "/www", "/fun", "/ciiwol/www/fun", "/www/fun"]:
              print("NLST", path, ":", safe_nlst(path))

          for path in [".", "fun", "www", "ciiwol", "ciiwol/www", "ciiwol/www/fun", "www/fun", "/ciiwol/www/fun/snake", "/www/fun/snake", "fun/snake", "www/fun/snake", "ciiwol/www/fun/snake"]:
              print("CWD", path, ":", safe_cwd(path))

          ftp.quit()
          PY
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}

      - name: Deploy to Cafe24 via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ steps.cfg.outputs.server }}
          username: ${{ steps.cfg.outputs.username }}
          password: ${{ steps.cfg.outputs.password }}
          protocol: ${{ steps.cfg.outputs.proto }}
          server-dir: ${{ steps.cfg.outputs.dir }}
          port: ${{ steps.cfg.outputs.port }}
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git/**
            **/.github/**
            **/.DS_Store
            scripts/**
            script/**
            tests/**
            test/**
            db/**
            node_modules/**
            db.local.php
            config.local.php
            config/local.php
            README.md
            README.MD
            README_KR.md
            README_KO.md
            AGENTS.md
            agents.md
            SPEC.md
            TODO.md
            DOCKER.md
            docker-compose.yml
            Dockerfile
            Makefile
            test.txt
